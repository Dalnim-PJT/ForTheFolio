{% extends 'base.html' %}
{% load static %}
{% block title %}MY DATA{% endblock title %}

{% block header %}
  <link rel="stylesheet" href="{% static 'mydata/css/create.css' %}" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
{% endblock header %}

{% block content %}
<div class="create--container">
  <form action="{% url 'portfolios:m_create' %}" method='POST' enctype='multipart/form-data'>
    {% csrf_token %}
    {{ basic.title }}
    <p id="title-error"></p>
    <div class="basic--container">
      <div class="basic--container--content">
        {{ basic.username }}
        {{ basic.job }}
        {{ basic.phone }}
        {{ basic.email }}
      </div>
      <div class="basic--container--content--image">
        <div class="image--header">
          <h1>프로필 사진</h1>
          {{ basic.image }}
        </div>
        <div class="imag--box">
          <img id="preview-image" src="#" alt="미리보기" style="display: none; width: 150px; height: 150px; margin:auto;">
        </div>
      </div>
    </div>
    <div class="link--header">
      <h3>링크</h3>
      <button type="button" id="add-link-entry">
        <svg width="15px" height="15px" viewBox="0 -0.5 9 9" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="gray"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>plus_mini [#1523]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-345.000000, -206.000000)" fill="gray"> <g id="icons" transform="translate(56.000000, 160.000000)"> <polygon id="plus_mini-[#1523]" points="298 49 298 51 294.625 51 294.625 54 292.375 54 292.375 51 289 51 289 49 292.375 49 292.375 46 294.625 46 294.625 49"> </polygon> </g> </g> </g> </g></svg>
      </button>
    </div>
    <div class="link--box">
      <div id="link-entries">
        <div class="link-entry">
          {{ link.link }}
          {{ link.link_content }}
        </div>
      </div>
    </div>
    
    {{ basic.introduction }}
    <div class="stack--box">
      <h1>스택</h1> 
      <select multiple class="select" id="b_stack_multi" name="b_stack_multi" style="width:335px; height:70px;" multiple="multiple">
        {% for stack in stacks %}
          <option value="{{stack.0}}">{{stack.0}}</option>
        {% endfor %}
      </select>
    </div>

    <div class="link--header">
      <h3>프로젝트</h3>
      <button type="button" id="add-pjt-entry">
        <svg width="15px" height="15px" viewBox="0 -0.5 9 9" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="gray"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>plus_mini [#1523]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-345.000000, -206.000000)" fill="gray"> <g id="icons" transform="translate(56.000000, 160.000000)"> <polygon id="plus_mini-[#1523]" points="298 49 298 51 294.625 51 294.625 54 292.375 54 292.375 51 289 51 289 49 292.375 49 292.375 46 294.625 46 294.625 49"> </polygon> </g> </g> </g> </g></svg>
      </button>
    </div>
      <div id="pjt-entries">
        <div class="pjt-entry">
          <div class="pjt--content">
            <h1>제목</h1>
            {{ pjt.name }}
            <div id="more-btn">
              <svg width="30px" height="30px" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#5c8dff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M4 9H11L7.5 4.5L4 9Z" fill="#5c8dff"></path> </g></svg>
            </div>
          </div>
          <div class="pjt--content">
            <h1>설명</h1>
            {{ pjt.pjts_content }}
          </div>

          <div class="pjt--content image--container">
            <h1>이미지</h1>
            <div id="image-preview-container-0" ondrop="handleImageDrop(event,0)" ondragover="handleDragOver(event)" onclick="openFileInput(0)" class="image-preview-container">
              <p id="placeholder-text-0" class="placeholder-text">클릭하거나 드래그하여 이미지를 추가하세요.</p>
            </div>
            {{ pjtimage }}
          </div>

          
          <div class="pjt--content">
            <h1>역할,<br>구현<br>기능</h1>
            {{ pjt.role }}
          </div>
          <div class="pjt--content">
            <h1>링크</h1>
              {{ pjt.github }}
              {{ pjt.web }}
          </div>
          <div class="pjt--content" id="stack--box">
            <h1>스택</h1>
            <select multiple class="select" id="p_stack_multi-0" name="p_stack_multi-0" style="width:335px; height:70px;" multiple="multiple">
              {% for stack in stacks %}
                <option value="{{stack.0}}">{{stack.0}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

    <div class="link--header">
      <h3>경력</h3>
      <button type="button" id="add-career-entry">
        <svg width="15px" height="15px" viewBox="0 -0.5 9 9" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="gray"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>plus_mini [#1523]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-345.000000, -206.000000)" fill="gray"> <g id="icons" transform="translate(56.000000, 160.000000)"> <polygon id="plus_mini-[#1523]" points="298 49 298 51 294.625 51 294.625 54 292.375 54 292.375 51 289 51 289 49 292.375 49 292.375 46 294.625 46 294.625 49"> </polygon> </g> </g> </g> </g></svg>
      </button>
    </div>
    <div class="link--box">
      <div id="career-entries">
        <div class="career-entry">
          {{ career.career_content }}
        </div>
      </div>
    </div>
    
    <input type="submit" value="작성 완료" id="submit-button">
  </form>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet"/>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.min.js" /></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    $("#b_stack_multi").select2();
  });	
  $(document).ready(function() {
    $("#p_stack_multi-0").select2();
  });
  $(document).ready(function() {
    var typingTimer;
    var doneTypingInterval = 100;
  
    checkDuplicatetitle();
  
    $('#id_title').on('input', function() {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(checkDuplicatetitle, doneTypingInterval);
  });
  
    function checkDuplicatetitle() {
      var title = $('#id_title').val();
  
      if (!title) {
        $('#title-error').hide();
        $('#submit-button').prop('disabled', false);
        return;
      }
  
        $.ajax({
            url: '/portfolios/check/',
            type: 'GET',
            data: {'title': title},
            success: function(response) {
                if (response.duplicate) {
                    $('#title-error').text('※ 중복된 title입니다.').show();
                    $('#submit-button').prop('disabled', true); 
                } else {
                    $('#title-error').hide();
                    $('#submit-button').prop('disabled', false);
                }
            }
        });
    }
  });
  
  function addLinkField() {
    const linkEntries = document.getElementById("link-entries");
    const firstLinkEntry = linkEntries.firstElementChild;

    const newLinkEntry = document.createElement("div");
    newLinkEntry.className = "link-entry";
    const newIndex = linkEntries.childElementCount;
    newLinkEntry.innerHTML = firstLinkEntry.innerHTML.replace(/link-\d+/g, `link-${newIndex}`);

    const closeButton = document.createElement("button");
    closeButton.innerHTML = "&#10006;";
    newLinkEntry.appendChild(closeButton);

    linkEntries.appendChild(newLinkEntry);
  }
  
  document.getElementById("add-link-entry").addEventListener("click", addLinkField);
  document.getElementById("link-entries").addEventListener("click", function(event) {
    if (event.target.tagName === "BUTTON") {
      const linkEntry = event.target.parentNode;
      linkEntry.remove();
    }
  });

  function addPjtField() {
    const pjtEntries = document.getElementById("pjt-entries");
    const firstPjtEntry = pjtEntries.firstElementChild;
    const newPjtEntry = document.createElement("div");
    newPjtEntry.className = "pjt-entry";

    const newIndex = pjtEntries.childElementCount;

    newPjtEntry.innerHTML = firstPjtEntry.innerHTML.replace(/pjt-\d+/g, `pjt-${newIndex}`);
    newPjtEntry.querySelector('.select').remove();
    newPjtEntry.querySelector('.select2').remove();

    const imageContainer = newPjtEntry.querySelector("#image-preview-container-0");
    const imageContents = imageContainer.querySelectorAll(".image-preview")
    
    imageContainer.setAttribute("id", `image-preview-container-${newIndex}`);
    imageContainer.setAttribute("name", `image-preview-container-${newIndex}`);
    imageContainer.setAttribute("ondrop", `handleImageDrop(event, ${newIndex})`);
    imageContainer.setAttribute("ondragover", "handleDragOver(event)");
    imageContainer.setAttribute("onclick", `openFileInput(${newIndex})`);
    imageContents.forEach((element) => {
      element.remove();
    });
    
    const placeholderText = newPjtEntry.querySelector("#placeholder-text-0");
    placeholderText.setAttribute("id", `placeholder-text-${newIndex}`);
    placeholderText.style.display = "block";

    const fileInput = newPjtEntry.querySelector("#image-upload-0");
    fileInput.setAttribute("id", `image-upload-${newIndex}`);
    fileInput.setAttribute("onclick", `openFileInput(${newIndex})`);
    fileInput.addEventListener("change", function (event) {
      handleImageUpload(event, newIndex);
    });

    const stacks = {{stacks|safe}};

    const selectElement = document.createElement('select');
    selectElement.multiple = true;
    selectElement.setAttribute('class', 'select select2-hidden-accessible');
    selectElement.setAttribute('id', `p_stack_multi-${newIndex}`);
    selectElement.setAttribute('name', `p_stack_multi-${newIndex}`);
    selectElement.style.width = '335px';
    selectElement.style.height = '70px';
    selectElement.setAttribute("data-select2-id", `p_stack_multi-${newIndex}`);

    stacks.forEach((stack) => {
      const optionElement = document.createElement('option');
      optionElement.setAttribute('value', stack);
      optionElement.textContent = stack;
      selectElement.appendChild(optionElement);
    });

    const closeButton = document.createElement("button");
    closeButton.innerHTML = "&#10006;";
    
    const pjtContentDiv = newPjtEntry.querySelector("#stack--box");

    pjtContentDiv.appendChild(selectElement);
    pjtContentDiv.appendChild(closeButton);

    newPjtEntry.appendChild(pjtContentDiv);
    pjtEntries.appendChild(newPjtEntry);
    

    $(`#p_stack_multi-${newIndex}`).select2();
    
  }

  document.getElementById("add-pjt-entry").addEventListener("click", addPjtField);
  document.getElementById("pjt-entries").addEventListener("click", function(event) {
    if (event.target.tagName === "BUTTON") {
      const pjtEntry = event.target.closest(".pjt-entry");
      pjtEntry.remove();
    }
  
    if (event.target.closest("#more-btn")) {
      const moreBtn = event.target.closest("#more-btn");
      const entry = event.target.closest(".pjt-entry");
      const contentSections = entry.querySelectorAll(".pjt--content:not(:first-child)");
      const isReversed = moreBtn.classList.toggle('is-reversed');
      const isHidden = isReversed;

      for (let i = 0; i < contentSections.length; i++) {
        const section = contentSections[i];
        section.classList.toggle("pjt--content-hidden", isHidden);
      }
    }
  });

  function handleImageUpload(event, index) {
    console.log(index) 
    const previewContainer = document.getElementById(`image-preview-container-${index}`);
    const files = event.target.files;

    for (const file of files) {
      addImageToPreview(previewContainer, file);
    }
    togglePlaceholderText(Number(previewContainer.getAttribute("id").split("-")[3]));
  }

  function handleDragOver(event) {
    event.preventDefault();
  }

  function handleImageDrop(event, index) {
    event.preventDefault();
    const previewContainer = document.getElementById(`image-preview-container-${index}`);
    const files = event.dataTransfer.files;

    for (const file of files) {
      addImageToPreview(previewContainer, file);
    }

    togglePlaceholderText(Number(previewContainer.getAttribute("id").split("-")[3]));
  }

  function addImageToPreview(previewContainer, file) {
    const reader = new FileReader();

    reader.onload = function (e) {
      const imagePreview = document.createElement("div");
      imagePreview.className = "image-preview";
      const image = new Image();
      image.src = e.target.result;
      image.alt = file.name;
      imagePreview.appendChild(image);

      const removeButton = document.createElement("div");
      removeButton.className = "remove-image-btn";
      removeButton.textContent = "x";
      removeButton.addEventListener("click", function () {
        imagePreview.remove();
        togglePlaceholderText(Number(previewContainer.getAttribute("id").split("-")[3]));
        event.stopPropagation();
      });
      
      imagePreview.appendChild(removeButton);
      previewContainer.appendChild(imagePreview);
      togglePlaceholderText(Number(previewContainer.getAttribute("id").split("-")[3]));
    };

    reader.readAsDataURL(file);
  }

  function openFileInput(index) {
    document.getElementById(`image-upload-${index}`).click();
  }

  function togglePlaceholderText(newIndex) {
    const placeholderText = document.getElementById(`placeholder-text-${newIndex}`);
    const previewContainer = document.getElementById(`image-preview-container-${newIndex}`);
    const previewContents = previewContainer.querySelector(".image-preview");
    if ( !previewContents ) {
      placeholderText.style.display = "block";
    } else {
      placeholderText.style.display = "none";
    }
  }

  document.getElementById(`image-upload-0`).addEventListener("change", function (event) {
    handleImageUpload(event, 0);
  });
  
  function addCareerField() {
    const careerEntries = document.getElementById("career-entries");
    const firstCareerEntry = careerEntries.firstElementChild;
    const newCareerEntry = document.createElement("div");
    newCareerEntry.className = "career-entry";

    const newIndex = careerEntries.childElementCount;
    newCareerEntry.innerHTML = firstCareerEntry.innerHTML.replace(/career-\d+/g, `career-${newIndex}`);
    const closeButton = document.createElement("button");
    closeButton.innerHTML = "&#10006;";
    newCareerEntry.appendChild(closeButton);
    
    careerEntries.appendChild(newCareerEntry);
  }

  document.getElementById("add-career-entry").addEventListener("click", addCareerField);
  document.getElementById("career-entries").addEventListener("click", function(event) {
    if (event.target.tagName === "BUTTON") {
      const careerEntry = event.target.parentNode;
      careerEntry.remove();
    }
  });

  function previewImage(event) {
    var input = event.target;
    if (input.files && input.files[0]) {
      var reader = new FileReader();
  
      reader.onload = function(e) {
        var preview = document.querySelector('#preview-image');
        preview.setAttribute('src', e.target.result);
        preview.style.display = 'block';
      };
  
      reader.readAsDataURL(input.files[0]);
    }
  }
  var imageInput = document.querySelector('#id_image');
  imageInput.addEventListener('change', previewImage);

</script> 
{% endblock content %}